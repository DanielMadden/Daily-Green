name: Daily green square

on:
  schedule:
    - cron: "0 16 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: daily-green
  cancel-in-progress: false

jobs:
  commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true

      - id: ts
        run: |
          echo "TZ=America/Denver" >> $GITHUB_ENV
          NOW="$(date +"%Y-%m-%d %H:%M:%S %Z")"
          TODAY="$(date +%F)"
          echo "now=$NOW" >> $GITHUB_OUTPUT
          echo "today=$TODAY" >> $GITHUB_OUTPUT

      - run: |
          FILE=heartbeat.txt
          touch "$FILE"
          if grep -q "^${{ steps.ts.outputs.today }} " "$FILE"; then
            echo "skip_commit=true" >> $GITHUB_ENV
            exit 0
          fi
          echo "${{ steps.ts.outputs.today }} â€“ ${{ steps.ts.outputs.now }}" >> "$FILE"
          tail -n 365 "$FILE" > "$FILE.tmp" && mv "$FILE.tmp" "$FILE"

      - if: env.skip_commit != 'true'
        env:
          GIT_AUTHOR_NAME: ${{ github.actor }}
          GIT_AUTHOR_EMAIL: ${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com
          GIT_COMMITTER_NAME: ${{ github.actor }}
          GIT_COMMITTER_EMAIL: ${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com
        run: |
          git config user.name  "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"

          git add heartbeat.txt
          git commit -m "chore: daily heartbeat ${{ steps.ts.outputs.today }}" \
            --author="$GIT_AUTHOR_NAME <$GIT_AUTHOR_EMAIL>"
          git push

